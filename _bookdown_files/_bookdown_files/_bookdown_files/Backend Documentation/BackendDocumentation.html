<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw);.lst-kix_vygj3rb92vwd-1>li:before{content:"\0025cb   "}ol.lst-kix_g3yklgvsbsyr-1.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-1 0}ol.lst-kix_g3yklgvsbsyr-8.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-8 0}.lst-kix_vygj3rb92vwd-3>li:before{content:"\0025cf   "}ol.lst-kix_g3yklgvsbsyr-7{list-style-type:none}.lst-kix_vygj3rb92vwd-0>li:before{content:"\0025cf   "}.lst-kix_vygj3rb92vwd-4>li:before{content:"\0025cb   "}ol.lst-kix_g3yklgvsbsyr-8{list-style-type:none}.lst-kix_vygj3rb92vwd-5>li:before{content:"\0025a0   "}.lst-kix_vygj3rb92vwd-6>li:before{content:"\0025cf   "}.lst-kix_g3yklgvsbsyr-8>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-8}.lst-kix_g3yklgvsbsyr-2>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-2}.lst-kix_vygj3rb92vwd-7>li:before{content:"\0025cb   "}.lst-kix_vygj3rb92vwd-8>li:before{content:"\0025a0   "}.lst-kix_g3yklgvsbsyr-7>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-7,lower-latin) ". "}.lst-kix_g3yklgvsbsyr-8>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-8,lower-roman) ". "}ul.lst-kix_vygj3rb92vwd-2{list-style-type:none}ul.lst-kix_vygj3rb92vwd-3{list-style-type:none}ul.lst-kix_vygj3rb92vwd-0{list-style-type:none}ul.lst-kix_vygj3rb92vwd-1{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-7.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-7 0}ol.lst-kix_g3yklgvsbsyr-0.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-0 0}ol.lst-kix_g3yklgvsbsyr-4.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-4 0}.lst-kix_g3yklgvsbsyr-1>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-1}.lst-kix_g3yklgvsbsyr-4>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-4}.lst-kix_g3yklgvsbsyr-7>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-7}ul.lst-kix_vygj3rb92vwd-8{list-style-type:none}ul.lst-kix_vygj3rb92vwd-6{list-style-type:none}ul.lst-kix_vygj3rb92vwd-7{list-style-type:none}.lst-kix_vygj3rb92vwd-2>li:before{content:"\0025a0   "}ul.lst-kix_vygj3rb92vwd-4{list-style-type:none}ul.lst-kix_vygj3rb92vwd-5{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-3.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-3 0}.lst-kix_g3yklgvsbsyr-5>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-5}ol.lst-kix_g3yklgvsbsyr-6.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-6 0}.lst-kix_g3yklgvsbsyr-0>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-0}.lst-kix_g3yklgvsbsyr-2>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-2,lower-roman) ". "}.lst-kix_g3yklgvsbsyr-4>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-4,lower-latin) ". "}.lst-kix_g3yklgvsbsyr-6>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-6}.lst-kix_g3yklgvsbsyr-3>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-3,decimal) ". "}.lst-kix_g3yklgvsbsyr-6>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-6,decimal) ". "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_g3yklgvsbsyr-3>li{counter-increment:lst-ctn-kix_g3yklgvsbsyr-3}.lst-kix_g3yklgvsbsyr-5>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-5,lower-roman) ". "}ol.lst-kix_g3yklgvsbsyr-5.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-5 0}ol.lst-kix_g3yklgvsbsyr-5{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-6{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-3{list-style-type:none}.lst-kix_g3yklgvsbsyr-0>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-0,decimal) ". "}ol.lst-kix_g3yklgvsbsyr-4{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-1{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-2{list-style-type:none}ol.lst-kix_g3yklgvsbsyr-2.start{counter-reset:lst-ctn-kix_g3yklgvsbsyr-2 0}ol.lst-kix_g3yklgvsbsyr-0{list-style-type:none}.lst-kix_g3yklgvsbsyr-1>li:before{content:"" counter(lst-ctn-kix_g3yklgvsbsyr-1,lower-latin) ". "}ol{margin:0;padding:0}table td,table th{padding:0}.c16{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:678pt;border-top-color:#000000;border-bottom-style:solid}.c29{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:681.8pt;border-top-color:#000000;border-bottom-style:solid}.c42{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:682.5pt;border-top-color:#000000;border-bottom-style:solid}.c39{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:683.2pt;border-top-color:#000000;border-bottom-style:solid}.c40{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:634.5pt;border-top-color:#000000;border-bottom-style:solid}.c13{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#333333;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c4{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left;margin-right:49.5pt}.c24{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c7{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left;margin-right:49.5pt}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c18{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c28{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c5{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c9{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c23{background-color:#333333;font-family:"Consolas";color:#ade5fc;font-weight:400}.c30{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c32{background-color:#333333;font-family:"Consolas";color:#d36363;font-weight:400}.c27{color:#434343;font-weight:400;font-size:14pt;font-family:"Arial"}.c20{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c6{background-color:#333333;font-family:"Consolas";color:#888888;font-weight:400}.c37{color:#000000;text-decoration:none;vertical-align:baseline;font-family:"Arial"}.c0{background-color:#333333;font-family:"Consolas";color:#ffffff;font-weight:400}.c25{border-spacing:0;border-collapse:collapse;margin-right:auto}.c3{background-color:#333333;font-family:"Consolas";color:#fcc28c;font-weight:400}.c1{background-color:#333333;font-family:"Consolas";color:#a2fca2;font-weight:400}.c36{margin-left:-62.2pt;border-spacing:0;border-collapse:collapse;margin-right:auto}.c21{text-decoration:none;vertical-align:baseline;font-style:normal}.c38{font-weight:400;font-size:20pt;font-style:normal}.c41{color:#d6d6dd;font-weight:400;font-family:"Consolas"}.c33{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c11{margin-left:72pt;padding-left:0pt}.c34{color:inherit;text-decoration:inherit}.c10{padding:0;margin:0}.c26{margin-left:36pt;padding-left:0pt}.c14{height:0pt}.c17{font-weight:700}.c8{height:11pt}.c19{font-style:italic}.c12{font-size:10.5pt}.c35{margin-left:72pt}.c31{font-size:11pt}.c15{height:132pt}.c22{margin-right:49.5pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c33 doc-content"><h1 class="c24 c22" id="h.f1dr822ozzxp"><span class="c37 c38">Docker</span></h1><h2 class="c4" id="h.6nj3yl3vxemf"><span class="c18">Basic Structure of a Dockerfile</span></h2><p class="c7"><span class="c2">A Dockerfile is a text file that contains a series of instructions on how to build a Docker image. Here&rsquo;s a basic structure for the Dockerfile for the VSSF R Shiny app:</span></p><p class="c7 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20"><span class="c0">FROM rocker/shiny<br><br>WORKDIR /VSSF<br><br>RUN apt-get update -qq &amp;&amp; apt-get -y --no-install-recommends install \<br> &nbsp; &nbsp;libxml2-dev \<br> &nbsp; &nbsp;libssl-dev \<br> &nbsp; &nbsp;libudunits2-dev \<br> &nbsp; &nbsp;libgdal-dev \<br> &nbsp; &nbsp;libprotobuf-dev \<br> &nbsp; &nbsp;protobuf-compiler \<br> &nbsp; &nbsp;libjq-dev \<br> &nbsp; &nbsp;&amp;&amp; rm -rf /var/lib/apt/lists/* \<br> &nbsp; &nbsp;&amp;&amp; apt-get clean<br><br><br>RUN Rscript -e </span><span class="c1">&#39;install.packages(c(&quot;shinyjs&quot;, &quot;leaflet&quot;, &quot;leafpop&quot;, &quot;sf&quot;, &quot;plotly&quot;, &quot;tidyverse&quot;, &quot;DT&quot;, &quot;geosphere&quot;, &quot;ggmap&quot;,&quot;httr2&quot;, &quot;jsonlite&quot;))&#39;</span><span class="c0"><br><br>COPY . .<br><br>EXPOSE </span><span class="c32">8180</span><span class="c0"><br><br>CMD R -e </span><span class="c1">&#39;shiny::runApp(&quot;shiny-app/App.R&quot;, port = 8180, host = &quot;0.0.0.0&quot;)&#39;</span><span class="c0"><br></span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><h2 class="c4" id="h.qgxzdaahu8qi"><span class="c18">Components</span></h2><p class="c7"><span class="c5">1. Base Image:</span></p><p class="c7"><span class="c2">Use a base image that includes R and Shiny. The rocker/shiny image is a good choice as it comes with Shiny Server pre-installed.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">2. Set Working Directory:</span></p><p class="c7"><span class="c2">Use the WORKDIR instruction to set the working directory inside the container. This is where your application files will reside.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">3. Install System Dependencies:</span></p><p class="c7"><span class="c2">Use the RUN instruction to install any system dependencies your app may require. This can include libraries for data manipulation, visualization, etc. Check which you are using, and which the packages you are using require and only include those.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">4. Install R Packages:</span></p><p class="c7"><span class="c2">Use RUN R -e &quot;install.packages(...)&quot; to install the necessary R packages. Specify a CRAN repository to ensure package availability.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">5. Copy Application Files:</span></p><p class="c7"><span class="c2">Use the COPY instruction to copy your application files (e.g., app.R, ui.R, server.R, etc.) into the container. Here we are copying all the files into the docker container.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">6. Expose Port:</span></p><p class="c7"><span class="c2">Use the EXPOSE instruction to specify the port on which the Shiny app will run. On gcp this is assigned separately so this exposed port is exposed on the docker container but not the cloud run service. </span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">7. Run the Application:</span></p><p class="c7"><span class="c2">Use the CMD instruction to specify the command that runs your Shiny app when the container starts.</span></p><p class="c7 c8"><span class="c2"></span></p><h2 class="c4" id="h.jiswc9f192v9"><span class="c18">Best Practices</span></h2><p class="c7"><span class="c17">.dockerignore File</span><span class="c2">: Create a .dockerignore file to exclude unnecessary files from being copied into the Docker image. This can help reduce the image size and build time.</span></p><p class="c7"><span class="c2">Example .dockerignore:</span></p><p class="c7 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20"><span class="c0">.Rhistory<br>.RData<br>*.Rproj<br>*.Rproj.</span><span class="c3">user</span><span class="c0"><br>.</span><span class="c3 c21 c31">env</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c17">Version Control:</span><span class="c2">&nbsp;Specify versions of R packages to ensure reproducibility. For example, use install.packages(&quot;ggplot2&quot;, version = &quot;3.3.5&quot;).</span></p><p class="c7"><span class="c17">Testing</span><span class="c2">: Test your Docker image locally before deploying it to ensure that everything works as expected.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><hr><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><h1 class="c24 c22" id="h.5b8hpptzw9g5"><span class="c37 c38">Api Request</span></h1><h2 class="c4" id="h.41hqtzfs4gq"><span class="c18">Format</span></h2><p class="c7"><span class="c2">The backend API can be accessed at: &lt;https://backend-v1-1010920399604.northamerica-northeast2.run.app/query&gt;, but it requires authentication with google first.</span></p><p class="c7"><span class="c2">Currently the way the backend is set up is that it takes a POST request in the following format: </span></p><p class="c7 c8"><span class="c2"></span></p><table class="c25"><tr class="c15"><td class="c13" colspan="1" rowspan="1"><p class="c20"><span class="c0">&#39;{<br> &nbsp;&quot;fun&quot;: </span><span class="c1">&quot;get&quot;</span><span class="c0">,<br> &nbsp;&quot;projectId&quot;: </span><span class="c1">&quot;magnetic-runway-428121-v3&quot;</span><span class="c0">,<br> &nbsp;&quot;datasetId&quot;: </span><span class="c1">&quot;schools&quot;</span><span class="c0">,<br> &nbsp;&quot;tableId&quot;: </span><span class="c1">&quot;enrolment&quot;</span><span class="c0">,<br> &nbsp;&quot;select&quot;: </span><span class="c1">&quot;Metric, Values&quot;</span><span class="c0">,<br> &nbsp;&quot;conditions&quot;: </span><span class="c1">&quot;WHERE District_Code = 35 AND Year = 2016/2017&quot;</span><span class="c0">,<br> &nbsp;&quot;additional&quot;: </span><span class="c1">&quot;&quot;</span><span class="c0 c21 c31"><br>}&#39;</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c2">Parameters:</span></p><ul class="c10 lst-kix_vygj3rb92vwd-0 start"><li class="c7 c26 li-bullet-0"><span class="c17">fun</span><span class="c2">: The request type for bigquery</span></li></ul><ul class="c10 lst-kix_vygj3rb92vwd-1 start"><li class="c7 c11 li-bullet-0"><span class="c2">get: returns a full table or specific rows based on params</span></li><li class="c7 c11 li-bullet-0"><span class="c2">exists: returns true if a table exists in big query</span></li><li class="c7 c11 li-bullet-0"><span class="c17 c19 c31 c37">TODO:</span></li><li class="c7 c8 c11 li-bullet-0"><span class="c37 c17 c19 c31"></span></li><li class="c7 c11 li-bullet-0"><span class="c2">create-table: creates a table and populates it with params </span></li><li class="c7 c11 li-bullet-0"><span class="c2">Insert: inserts data in a table specified in params</span></li></ul><ul class="c10 lst-kix_vygj3rb92vwd-0"><li class="c7 c26 li-bullet-0"><span class="c17">Select: </span><span class="c2">What needs to go into the spaces after &ldquo;SELECT ____&rdquo;</span></li><li class="c7 c26 li-bullet-0"><span class="c17">conditions:</span><span class="c2">: The sql commands for specifying data from big query:</span></li></ul><ul class="c10 lst-kix_vygj3rb92vwd-1 start"><li class="c7 c11 li-bullet-0"><span class="c2">The commands should be what comes after &ldquo;select * from table &hellip;&rdquo; in a regular string</span></li></ul><p class="c7 c8 c35"><span class="c2"></span></p><ul class="c10 lst-kix_vygj3rb92vwd-0"><li class="c7 c26 li-bullet-0"><span class="c17">additional:</span><span class="c2">&nbsp;Refers to what comes after a standard &ldquo;SELECT * FROM table where x = y &hellip;&rdquo; &nbsp;</span></li></ul><ul class="c10 lst-kix_vygj3rb92vwd-1 start"><li class="c7 c11 li-bullet-0"><span class="c2">TODO</span></li></ul><p class="c7 c8"><span class="c2"></span></p><h2 class="c4" id="h.87pkf1bvjqo6"><span class="c18">Testing</span></h2><p class="c7"><span class="c2">To test if the endpoint is accessible with a cURL request, you will have to use the Google Cloud SDK, either in a local cloud sdk terminal or using the terminal in the Cloud Console. Once you&rsquo;ve logged in on either method, use this command to test the backend&rsquo;s communication:</span></p><p class="c7 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20 c22"><span class="c0">curl -X POST -H </span><span class="c1">&quot;Authorization: Bearer </span><span class="c23">$(gcloud auth print-identity-token)</span><span class="c1">&quot;</span><span class="c0">&nbsp;-H </span><span class="c1">&quot;Content-Type: application/json&quot;</span><span class="c0">&nbsp;-d &#39;{<br> &nbsp;&quot;fun&quot;: </span><span class="c1">&quot;get&quot;</span><span class="c0">,<br> &nbsp;&quot;projectId&quot;: </span><span class="c1">&quot;magnetic-runway-428121-v3&quot;</span><span class="c0">,<br> &nbsp;&quot;datasetId&quot;: </span><span class="c1">&quot;schools&quot;</span><span class="c0">,<br> &nbsp;&quot;tableId&quot;: </span><span class="c1">&quot;enrolment&quot;</span><span class="c0">,<br> &nbsp;&quot;select&quot;: </span><span class="c1">&quot;Metric, Values&quot;</span><span class="c0">,<br> &nbsp;&quot;conditions&quot;: </span><span class="c1">&quot;WHERE District_Code = 35 AND Year = 2016/2017&quot;</span><span class="c0">,<br> &nbsp;&quot;additional&quot;: </span><span class="c1">&quot;;&quot;</span><span class="c0"><br>}&#39;</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span>The -H header will contain your google accounts token that will be used to verify the request. Do not share this number with anyone. The -d data section is the body of the request. In this example it is &ldquo;getting&rdquo; the metric and values from the </span><span class="c19">enrolment </span><span>table in the </span><span class="c19">schools </span><span class="c2">database where the district code is 35 and the year is 2016/2017. This will return the whole table, so if you are just checking connectivity, then a smaller piece of data would be better. </span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><hr><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><h1 class="c24 c22" id="h.zbdptxrb18bl"><span class="c37 c38">API Access with R Shiny Integration</span></h1><p class="c7"><span class="c2">This documentation describes how to interact with the BigQuery API endpoint from an R Shiny application using the httr2 package.</span></p><h2 class="c4" id="h.68855qiwuqn9"><span class="c18">Base Configuration</span></h2><p class="c7"><span class="c2">First, set up the necessary HTTP configuration in your R Shiny application:</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20 c22"><span class="c3">library</span><span class="c0">(httr2)<br></span><span class="c3">library</span><span class="c0">(jsonlite)<br><br></span><span class="c6"># Base API configuration</span><span class="c0"><br>base_url &lt;- </span><span class="c1">&quot;Api-Url&quot;</span><span class="c0"><br><br></span><span class="c6"># Create a base request object</span><span class="c0"><br>req_base &lt;- request(base_url) |&gt;<br> &nbsp;req_headers(</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">)</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span>The Api-Url can be found </span><span class="c30"><a class="c34" href="#h.41hqtzfs4gq">here</a></span></p><h2 class="c4" id="h.svf3e53um10m"><span class="c18"><br>Available Endpoints</span></h2><p class="c9 c8"><span class="c2"></span></p><p class="c9"><span class="c2">The following are the functions currently implemented in the backend, and can be accessed via direct cURL request or copying and pasting the corresponding functions into your r shiny folder</span></p><h3 class="c22 c28" id="h.qyg7ivu6q9qp"><span class="c27 c21">1. Query Data (/query)</span></h3><p class="c7"><span class="c2">Retrieves data from a BigQuery table. Makes a request to the backend with an sql query.</span></p><p class="c7 c8"><span class="c2"></span></p><table class="c36"><tr class="c14"><td class="c40" colspan="1" rowspan="1"><p class="c20"><span class="c0">any_query &lt;- </span><span class="c3">function</span><span class="c0">(</span><span class="c3">...</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prj = </span><span class="c1">&quot;magnetic-runway-428121&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ds = </span><span class="c1">&quot;schools&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tbl = </span><span class="c1">&quot;info&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; select = </span><span class="c1">&quot;*&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; additional = </span><span class="c1">&quot;&quot;</span><span class="c0">) {<br> &nbsp;<br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;</span><span class="c6"># Base API configuration</span><span class="c0"><br> &nbsp; &nbsp;base_url &lt;- </span><span class="c1">&quot;https://backend-v1-1010920399604.northamerica-northeast2.run.app&quot;</span><span class="c0"><br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c6"># Get identity token from metadata server</span><span class="c0"><br> &nbsp; &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp; &nbsp;print(</span><span class="c1">&quot;Attempting to get identity token...&quot;</span><span class="c0">)<br> &nbsp; &nbsp; &nbsp;id_token &lt;- request(</span><span class="c1">&quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp; &nbsp;req_url_query(audience = base_url) |&gt;<br> &nbsp; &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Metadata-Flavor&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;Google&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp; &nbsp;req_perform(verbosity = </span><span class="c32">1</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp; &nbsp;resp_body_string()<br> &nbsp; &nbsp; &nbsp;print(</span><span class="c1">&quot;Token received successfully&quot;</span><span class="c0">)<br> &nbsp; &nbsp;},<br> &nbsp; &nbsp;error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MS Connection failed. Full error:&quot;</span><span class="c0">, e))<br> &nbsp; &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Error message:&quot;</span><span class="c0">, e$message))<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(!is.null(e$parent)) print(paste(</span><span class="c1">&quot;Parent error:&quot;</span><span class="c0">, e$parent$message))<br> &nbsp; &nbsp;},<br> &nbsp; &nbsp;</span><span class="c3">warning</span><span class="c0">&nbsp;= </span><span class="c3">function</span><span class="c0">(w) {<br> &nbsp; &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MSWarning:&quot;</span><span class="c0">, w$message))<br> &nbsp; &nbsp;})<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c6"># Create a base request object with authorization</span><span class="c0"><br> &nbsp; &nbsp;req_base &lt;- request(base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Authorization&quot;</span><span class="c0">&nbsp;= paste(</span><span class="c1">&quot;Bearer&quot;</span><span class="c0">, id_token)<br> &nbsp; &nbsp; &nbsp;)<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c6"># Prepare the request body</span><span class="c0"><br> &nbsp; &nbsp;body &lt;- list(<br> &nbsp; &nbsp; &nbsp;fun = </span><span class="c1">&quot;get&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp;projectId = prj,<br> &nbsp; &nbsp; &nbsp;datasetId = ds,<br> &nbsp; &nbsp; &nbsp;tableId = tbl,<br> &nbsp; &nbsp; &nbsp;select = select,<br> &nbsp; &nbsp; &nbsp;conditions = paste(c(</span><span class="c3">...</span><span class="c0">), collapse = </span><span class="c1">&quot; &quot;</span><span class="c0">),<br> &nbsp; &nbsp; &nbsp;additional = additional<br> &nbsp; &nbsp;)<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c6"># Make the API request</span><span class="c0"><br> &nbsp; &nbsp;response &lt;- req_base |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path(</span><span class="c1">&quot;query&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_body_json(body) |&gt;<br> &nbsp; &nbsp; &nbsp;req_perform()<br> &nbsp; &nbsp;<br> &nbsp; &nbsp;</span><span class="c6"># Parse the response</span><span class="c0"><br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(resp_status(response) == </span><span class="c32">200</span><span class="c0">) {<br> &nbsp; &nbsp; &nbsp;result_json &lt;- fromJSON(rawToChar(response$body))<br> &nbsp; &nbsp; &nbsp;result_df &lt;- as.data.frame(result_json)<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(result_df)<br> &nbsp; &nbsp;} </span><span class="c3">else</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;API request failed: &quot;</span><span class="c0">, resp_body_string(response)))<br> &nbsp; &nbsp;}<br> &nbsp;},<br> &nbsp;error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Connection failed:&quot;</span><span class="c0">, e$message))<br> &nbsp;},<br> &nbsp;</span><span class="c3">warning</span><span class="c0">&nbsp;= </span><span class="c3">function</span><span class="c0">(w) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Warning:&quot;</span><span class="c0 c21 c31">, w$message))<br> &nbsp;})<br>}</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c2">There are two main parts to this function. The first is to make a request to the google metadata servers to get an access token. This token is then used in the header of the actual request to the backend. If you get an &ldquo;MS connection failed&rdquo; something has failed in this initial metadata server request. The second part is the actual request to the backend API.</span></p><p class="c7 c8"><span class="c2"></span></p><h3 class="c28 c22" id="h.6042mjii6v9"><span class="c27 c21">2. Get Datasets (/datasets/:projectId)</span></h3><p class="c9"><span class="c2">This function gets all datasets in a specified project.</span></p><table class="c25"><tr class="c14"><td class="c29" colspan="1" rowspan="1"><p class="c20"><span class="c0">get_datasets &lt;- </span><span class="c3">function</span><span class="c0">(project_id) {<br> &nbsp;base_url &lt;- </span><span class="c1">&quot;https://backend-v1-1010920399604.northamerica-northeast2.run.app&quot;</span><span class="c0">&nbsp; </span><span class="c6"># Adjust this to your server URL</span><span class="c0"><br><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Attempting to get identity token...&quot;</span><span class="c0">)<br> &nbsp; &nbsp;id_token &lt;- request(</span><span class="c1">&quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_query(audience = base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Metadata-Flavor&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;Google&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_perform(verbosity = </span><span class="c32">1</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;resp_body_string()<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Token received successfully&quot;</span><span class="c0">)<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MS Connection failed. Full error:&quot;</span><span class="c0">, e))<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Error message:&quot;</span><span class="c0">, e$message))<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(!is.null(e$parent)) print(paste(</span><span class="c1">&quot;Parent error:&quot;</span><span class="c0">, e$parent$message))<br> &nbsp;}, </span><span class="c3">warning</span><span class="c0">&nbsp;= </span><span class="c3">function</span><span class="c0">(w) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MSWarning:&quot;</span><span class="c0">, w$message))<br> &nbsp;})<br><br> &nbsp;req &lt;- request(base_url) |&gt;<br> &nbsp; &nbsp;req_url_path_append(</span><span class="c1">&quot;datasets&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp;req_url_path_append(project_id) |&gt;<br> &nbsp; &nbsp;req_headers(<br> &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Authorization&quot;</span><span class="c0">&nbsp;= paste(</span><span class="c1">&quot;Bearer&quot;</span><span class="c0">, id_token)<br> &nbsp; &nbsp;)<br><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;resp &lt;- req |&gt; req_perform()<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(resp_status(resp) == </span><span class="c32">200</span><span class="c0">) {<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(resp_body_json(resp))<br> &nbsp; &nbsp;}<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;</span><span class="c3">warning</span><span class="c0">(</span><span class="c1">&quot;Failed to fetch datasets: &quot;</span><span class="c0">, e$message)<br> &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(</span><span class="c3">NULL</span><span class="c0 c21 c31">)<br> &nbsp;})<br>}</span></p></td></tr></table><p class="c9 c8"><span class="c2"></span></p><h3 class="c28 c22" id="h.6cywapejctnm"><span class="c21 c27">3. Get Tables (/tables/:projectId/:datasetId</span></h3><p class="c9"><span class="c2">Gets tables in a specified project and dataset.</span></p><p class="c9 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c39" colspan="1" rowspan="1"><p class="c20"><span class="c0">get_tables &lt;- </span><span class="c3">function</span><span class="c0">(project_id, dataset_id) {<br> &nbsp;base_url &lt;- </span><span class="c1">&quot;https://backend-v1-1010920399604.northamerica-northeast2.run.app&quot;</span><span class="c0">&nbsp; </span><span class="c6"># Adjust this to your server URL</span><span class="c0"><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Attempting to get identity token...&quot;</span><span class="c0">)<br> &nbsp; &nbsp;id_token &lt;- request(</span><span class="c1">&quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_query(audience = base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Metadata-Flavor&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;Google&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_perform(verbosity = </span><span class="c32">1</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;resp_body_string()<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Token received successfully&quot;</span><span class="c0">)<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MS Connection failed. Full error:&quot;</span><span class="c0">, e))<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Error message:&quot;</span><span class="c0">, e$message))<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(!is.null(e$parent)) print(paste(</span><span class="c1">&quot;Parent error:&quot;</span><span class="c0">, e$parent$message))<br> &nbsp;}, </span><span class="c3">warning</span><span class="c0">&nbsp;= </span><span class="c3">function</span><span class="c0">(w) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MSWarning:&quot;</span><span class="c0">, w$message))<br> &nbsp;})<br> &nbsp;<br> &nbsp;req &lt;- request(base_url) |&gt;<br> &nbsp; &nbsp;req_url_path_append(</span><span class="c1">&quot;tables&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp;req_url_path_append(project_id) |&gt;<br> &nbsp; &nbsp;req_url_path_append(dataset_id) |&gt;<br> &nbsp; &nbsp;req_headers(<br> &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Authorization&quot;</span><span class="c0">&nbsp;= paste(</span><span class="c1">&quot;Bearer&quot;</span><span class="c0">, id_token)<br> &nbsp; &nbsp;)<br><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;resp &lt;- req |&gt; req_perform()<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(resp_status(resp) == </span><span class="c32">200</span><span class="c0">) {<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(resp_body_json(resp))<br> &nbsp; &nbsp;}<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;</span><span class="c3">warning</span><span class="c0">(</span><span class="c1">&quot;Failed to fetch datasets: &quot;</span><span class="c0">, e$message)<br> &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(</span><span class="c3">NULL</span><span class="c0 c21 c31">)<br> &nbsp;})<br>}</span></p></td></tr></table><p class="c9 c8"><span class="c2"></span></p><h3 class="c28 c22" id="h.m5cidt7wkosl"><span class="c27 c21">4. Get Headers (/column_headers/:projectId/:datasetId/:tableId)</span></h3><p class="c9"><span class="c2">Gets all headers in a specified project, dataset and table</span></p><table class="c25"><tr class="c14"><td class="c42" colspan="1" rowspan="1"><p class="c20"><span class="c0">get_headers &lt;- </span><span class="c3">function</span><span class="c0">(project_id, dataset_id, table_id) {<br> &nbsp;base_url &lt;- </span><span class="c1">&quot;https://backend-v1-1010920399604.northamerica-northeast2.run.app&quot;</span><span class="c0">&nbsp; </span><span class="c6"># Adjust this to your server URL</span><span class="c0"><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Attempting to get identity token...&quot;</span><span class="c0">)<br> &nbsp; &nbsp;id_token &lt;- request(</span><span class="c1">&quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_query(audience = base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Metadata-Flavor&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;Google&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_perform(verbosity = </span><span class="c32">1</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;resp_body_string()<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Token received successfully&quot;</span><span class="c0">)<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MS Connection failed. Full error:&quot;</span><span class="c0">, e))<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Error message:&quot;</span><span class="c0">, e$message))<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(!is.null(e$parent)) print(paste(</span><span class="c1">&quot;Parent error:&quot;</span><span class="c0">, e$parent$message))<br> &nbsp;}, </span><span class="c3">warning</span><span class="c0">&nbsp;= </span><span class="c3">function</span><span class="c0">(w) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MSWarning:&quot;</span><span class="c0">, w$message))<br> &nbsp;})<br><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;req &lt;- request(base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(</span><span class="c1">&quot;column_headers&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(project_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(dataset_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(table_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Authorization&quot;</span><span class="c0">&nbsp;= paste(</span><span class="c1">&quot;Bearer&quot;</span><span class="c0">, id_token)<br> &nbsp; &nbsp; &nbsp;)<br> &nbsp; &nbsp;resp &lt;- req |&gt; req_perform()<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(resp_status(resp) == </span><span class="c32">200</span><span class="c0">) {<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(resp_body_json(resp))<br> &nbsp; &nbsp;}<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;</span><span class="c3">warning</span><span class="c0">(</span><span class="c1">&quot;Failed to fetch datasets: &quot;</span><span class="c0">, e$message)<br> &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(</span><span class="c3">NULL</span><span class="c0 c21 c31">)<br> &nbsp;})<br>}</span></p></td></tr></table><p class="c9 c8"><span class="c2"></span></p><p class="c9 c8"><span class="c2"></span></p><h3 class="c28" id="h.2u19l0cin7dh"><span class="c27 c21">5. Get Unique Values (/unique_values/:projectId/:datasetId/:tableId/:columnName)</span></h3><p class="c9"><span class="c2">Gets all the unique values from a specific column, in a specified project, dataset and table.</span></p><p class="c9 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c16" colspan="1" rowspan="1"><p class="c20"><span class="c0">get_unique_values &lt;- </span><span class="c3">function</span><span class="c0">(project_id, dataset_id, table_id, column_name) {<br> &nbsp;base_url &lt;- </span><span class="c1">&quot;https://backend-v1-1010920399604.northamerica-northeast2.run.app&quot;</span><span class="c0">&nbsp; </span></p><p class="c20"><span class="c0">&nbsp; <br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Attempting to get identity token...&quot;</span><span class="c0">)<br> &nbsp; &nbsp;id_token &lt;- request(</span><span class="c1">&quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_query(audience = base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Metadata-Flavor&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;Google&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_perform(verbosity = </span><span class="c32">1</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;resp_body_string()<br> &nbsp; &nbsp;print(</span><span class="c1">&quot;Token received successfully&quot;</span><span class="c0">)<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;MS Connection failed. Full error:&quot;</span><span class="c0">, e))<br> &nbsp; &nbsp;print(paste(</span><span class="c1">&quot;Error message:&quot;</span><span class="c0">, e$message))<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(!is.null(e$parent)) print(paste(</span><span class="c1">&quot;Parent error:&quot;</span><span class="c0">, e$parent$message))<br> &nbsp;})<br><br> &nbsp;</span><span class="c3">tryCatch</span><span class="c0">({<br> &nbsp; &nbsp;req &lt;- request(base_url) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(</span><span class="c1">&quot;unique_values&quot;</span><span class="c0">) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(project_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(dataset_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(table_id) |&gt;<br> &nbsp; &nbsp; &nbsp;req_url_path_append(column_name) |&gt;<br> &nbsp; &nbsp; &nbsp;req_headers(</span><span class="c1">&quot;Content-Type&quot;</span><span class="c0">&nbsp;= </span><span class="c1">&quot;application/json&quot;</span><span class="c0">,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c1">&quot;Authorization&quot;</span><span class="c0">&nbsp;= paste(</span><span class="c1">&quot;Bearer&quot;</span><span class="c0">, id_token))<br><br> &nbsp; &nbsp;resp &lt;- req |&gt; req_perform()<br> &nbsp; &nbsp;</span><span class="c3">if</span><span class="c0">&nbsp;(resp_status(resp) == </span><span class="c32">200</span><span class="c0">) {<br> &nbsp; &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(resp_body_json(resp))<br> &nbsp; &nbsp;}<br> &nbsp;}, error = </span><span class="c3">function</span><span class="c0">(e) {<br> &nbsp; &nbsp;</span><span class="c3">warning</span><span class="c0">(</span><span class="c1">&quot;Failed to fetch unique values: &quot;</span><span class="c0">, e$message)<br> &nbsp; &nbsp;</span><span class="c3">return</span><span class="c0">(</span><span class="c3">NULL</span><span class="c0">)<br> &nbsp;})<br>}</span></p></td></tr></table><p class="c7 c8"><span class="c2"></span></p><h2 class="c4" id="h.bdu1xapexv9q"><span class="c18">Troubleshooting</span></h2><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">1. Check API URL:</span></p><p class="c7"><span class="c2">Ensure that the base_url is correctly set to your API endpoint. Test the URL in a web browser or a tool like Postman to confirm it&#39;s reachable.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">2. Verify API Status:</span></p><p class="c7"><span>Check if the API server is running and accessible. You can use tools like curl or Postman to send a test request to the API. </span><span class="c30"><a class="c34" href="#h.87pkf1bvjqo6">Testing</a></span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">3. Inspect Network Issues:</span></p><p class="c7"><span class="c2">Ensure there are no network issues preventing your Shiny app from reaching the API. Check your firewall settings and network configurations.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">Review API Response:</span></p><p class="c7"><span class="c2">If the API returns an error, inspect the response body for error messages. You can log the response content in your Shiny app to help diagnose issues.</span></p><p class="c7"><span class="c2">&nbsp;</span></p><p class="c7"><span class="c5">5. Validate Input Parameters:</span></p><p class="c7"><span class="c2">Ensure that the input parameters (e.g., dataset_id, table_id) are valid and correctly formatted. Invalid parameters can lead to API errors.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c5">6. TryCatch: </span></p><p class="c7"><span class="c2">To prevent your app from crashing when an API request fails you can use a trycatch block to ensure the program continues to function properly:</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7"><span class="c2">The error function is called if the request attempt fails. After the error function is called, the program continues.</span></p><p class="c7 c8"><span class="c2"></span></p><p class="c7 c8"><span class="c2"></span></p><h1 class="c22 c24" id="h.dbw4312u9j6h"><span class="c37 c38">Secrets and Environment Variables</span></h1><p class="c9"><span class="c2">All API keys and other sensitive data must not be in any code that is committed or otherwise uploaded anywhere on the Internet. Instead it must be stored as an environment variable. For example:</span></p><p class="c9 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20"><span class="c0 c12">google_api_key &lt;- 9845vn29475ynb2b3948572438</span></p></td></tr></table><p class="c9 c8"><span class="c2"></span></p><p class="c9"><span>Should be rewritten like this:</span></p><p class="c9 c8"><span class="c2"></span></p><table class="c25"><tr class="c14"><td class="c13" colspan="1" rowspan="1"><p class="c20"><span class="c0 c12">google_api_key &lt;- Sys.getenv(</span><span class="c1 c12">&quot;GOOGLE_MAPS_API_KEY&quot;</span><span class="c0 c12">, </span><span class="c1 c12">&quot;&quot;</span><span class="c0 c12">)<br></span><span class="c3 c12">if</span><span class="c0 c12">&nbsp;(google_api_key == </span><span class="c1 c12">&quot;&quot;</span><span class="c0 c12">) {<br> &nbsp;</span><span class="c3 c12">stop</span><span class="c0 c12">(</span><span class="c1 c12">&quot;Google Maps API key not found in environment variables&quot;</span><span class="c0 c12">)<br>}</span></p></td></tr></table><p class="c9 c8"><span class="c2"></span></p><p class="c9"><span>The if statement is optional, but recommended for values that are </span><span class="c19">essential </span><span class="c2">for the code to run as it prevents the rest of the code from running if the key is left blank (ie not configured correctly)</span></p><p class="c9 c8"><span class="c2"></span></p><p class="c9"><span class="c2">To add the value of the API key to the environment variables:</span></p><p class="c9 c8"><span class="c2"></span></p><ol class="c10 lst-kix_g3yklgvsbsyr-0 start" start="1"><li class="c9 c26 li-bullet-0"><span class="c2">Navigate to the &ldquo;Edit and Deploy New Revision&rdquo; menu</span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-1 start" start="1"><li class="c9 c11 li-bullet-0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 713.62px; height: 292.20px;"><img alt="" src="images/image1.png" style="width: 713.62px; height: 292.20px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-0" start="2"><li class="c9 c26 li-bullet-0"><span class="c2">Under the &ldquo;Edit Container&rdquo; section click the &ldquo;Variables and Secrets&rdquo; and click &ldquo;+ Add Variable&rdquo;</span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-1 start" start="1"><li class="c9 c11 li-bullet-0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 782.00px; height: 545.00px;"><img alt="" src="images/image2.png" style="width: 782.00px; height: 545.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-0" start="3"><li class="c9 c26 li-bullet-0"><span class="c2">In the Name section write what you would like to call the variable in your code:</span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-1 start" start="1"><li class="c9 c11 li-bullet-0"><span class="c2">&nbsp;In this case we use ALLOWED_ORIGIN to refer to our environment variable:</span></li><li class="c9 c11 li-bullet-0"><span>&nbsp;</span><span class="c0 c12">Sys.getenv(</span><span class="c1 c12">&quot;ALLOWED_ORIGIN&quot;</span><span class="c0 c12">, </span><span class="c1 c12">&quot;&quot;</span><span class="c0 c12">)</span></li></ol><ol class="c10 lst-kix_g3yklgvsbsyr-0" start="4"><li class="c9 c26 li-bullet-0"><span>In the Value section copy and paste the value of the variable.</span></li></ol><p class="c9 c8"><span class="c0 c12 c21"></span></p></body></html>